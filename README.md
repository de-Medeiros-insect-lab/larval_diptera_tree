# larval_diptera_tree
Code and data used to create a tree to study larval Diptera evolution.

The goal is to use as much data as available on gene bank for genus-level relationships and combine with the best available phylogenetic knowledge in the form of constraints.

# Step 1 - phylotar

We used phylotaR to retrieve the initial dataset. See folder phylotaR for options and scripts. Briefly, we kept all phylotaR clusters that were shared for a good number of Diptera genera and tentatively named these clusters based on common terms for these sequences in NCBI

# Step 2 - manually choose one per genus

Using phylotaR tools, we kept up to 3 sequences per genus (the 3 longest). We then did initial alignments and manually selected one sequence per genus that seemed to have the best alignment to other sequences. The results are saved in folder sequences/clean_sequences

# Step 3 - manually add additional taxa

Because we continued phenotyping larvae after the original phylotaR dataset, we manually used BLAST on gene bank to enrich our datasets for additional taxa. We did not increase the number of genes. Additional sequences are found in folder sequences/seq_added

# Step 4 - alignments

folder alignments

MACSE for protein-coding
MAFFT for ribosomal and mitocondrial. 

Note: for rDNA, we noticed that alignments were very poor, apparently because unrelated regions were aligned. To mitigate this, we manually downloaded references sequences from genomes and mitogenomes encompassing all of the alignment region. We first BLASTED genomes in NCBI, downloaded the BLAST regions and also flanking regions. We then used Geneious to map all of the sequences in our alignment to this extract, refining the region of interest to the are that haf any sequences mapping. We finally went back to the genome in NCBI and used BLAST with the original the exact region as query to extract a fasta file containing only the region of interest.

Because we had these full-length references, we used a two-step approach for these aligments: we first aligned the reference sequences, and then we added the other sequences ussing --addfragments option in mafft.

# Step 5 - trimming and manual curation

After alignments, we lightly trimmed alignments removing flanking regions with few data points. For 18S and 28S, we also trimmed regions with fewer than 4 sequences in the middle of alignments. For the other genes, we manually trimmed the middle in multiples of 3 to avoid frame shifts.

# Step 6 - concatenate alignments

We used phyutility to concatenate alignments and export in nexus format. We then manually edited the comments in this nexus file generated by phyutility to generate a partition file for IQTREE. For the 12S_16S cluster, we additionally used Geneious to annotate the alignments and identify coding and noncoding regions (this cluster included from 12S to cytb).
Final alignment and its concatenated version are saved in folder alignments/alignments_trimmed_cleaned

# Step 7 -  Phylogenetic constraints
We used the trees listed in folder constraint_trees to generate phylogenetic constraints.

Because tip names in phylogenies added as supplementary material are not standardized and often lack all relevant taxonomic information, the first step was to use a large language model (chatGPT v4) to assist in name parsing. the chat can be found here: https://chat.openai.com/share/13934687-d473-4eb6-8af3-4c7dedc836e5

Then, we manually checked the generated table for errors and used TaxReformer to pull additional data. 

With that information and manually rooted trees obtained from the primary sources, we were able to generate constraints. All steps are described in the  jupyter notebook: scripts/create_constraint.ipynb

# Step 8 - preliminary ML inferences and dataset refinement

## Step 8.1 - Maximum likelihood tree
We copied the concatenated alignment, phylogenetic constraints and made an IQTREE partition file in the folder analyses/IQTREE. It also constains the bash script that calls IQTREE with all options.

## Step 8.2 - unconstrained maximum likelihood tree
We initially tried running IQTREE (folder analyses/preliminary_analyses/iqtree), but got an error of negative branch length when running Step 8. Therefore, we ran an unconstrained ML tree to find taxa that may be mislabelled/misplaced (such as NUMT copies) (folder analyses/preliminary_analyses/iqtree_unconstrained).

Based on the results, we manually noted samples that seemed misplaced based on superfamily clusters. From these, we decided to exclude samples that (1) had sequence information from only 1 gene AND (2) had bootstrap values <50. These samples were excluded from the constraint tree and concatenated sequence files:
Tricyphona_700863
Lauterborniella_288850
Sylvicola_52753
Notiphila_1118049
Cistudinomyia_2173397
Aulacigaster_716608
Chonocephalus_92528
Pachylophus_1990794
Hemerodromia_626769
Mydaea_559689
Cobboldia_2583773
Onesiomima_2173510
Ochthera_1744809
Nothomicrodon_185774
Neoalticomerus_716622

The ML alignment and analysis done with this dataset is in analyses/preliminary_analyses/iqtree_constrained

## Step 8.3 
Manually noted additional samples that seemed misplaced based on family clusters. From these, excluded samples that (1) had sequence information from only 1 or 2 genes AND (2) for whom monophyly is unclear in the literature. All Oestridae and Psychodidae were retained. Olbiogaster_560768 was removed. 

# Step 9 - Reassemble and align dataset
After making a list of rogue taxa, we decided to restart the whole alingment process without those sequences. all of the preliminary analyses have been kep under `alignments/preliminary_alignments/` and `analyses/preliminary_analyses/`. The list of genera removed for the final dataset can be found at `alignments/to_align_without_rogues/sequencesremoved.txt`. 

Notes: 

1 - due to a mistake, Nothomicrodon_185774 and Pseudacteon_378799 had not been removed from the COI fasta sequences initially, and we manually removed them from the final alignments in `alignments/aligned_trimmed_cleaned/`

2 - Miltogramma was manually downloaded and added to the dataset, since it was not in the original search list for phylotaR.

3 - Whenever we had full-sequences for Aedes, Drosophila and Lucilia as references for alingments (18S, 28S, 12S_16S), we kept those and removed the sequences initially found by phylotaR. It seems phylotaR does not search the genome dataset, and had only fragmentary sequences for these taxa even though longer sequences were available.

The final pipeline to obtain alignments consists of:

1 - use `alignments/to_align_without_rogues/remove_seqs.sh` to remove rogue sequences
2 - use `alignments/run_mafft.sh`, `alignments/run_macse_NPC.sh` and `alignments/run_macse_COI.sh` to respectively align ribosomal sequences, nuclear protein-coding genes and COI. In the case of ribosomal sequences (which also include a large mitogenome alignment including proteinds and ribosomal sequences), the script adds refences for Aedes, Drosophila and Lucilia to guide the alignment of fragmentary sequences with mafft. In the case of protein-coding genes, we use a translation-guided alignment with macse.
3 - use `move_and_trim.sh` to move alignments obtained to the folder `aligned`, and them trim their ends and move the result to `aligned_trimmed`
4 - manually copy fasta files from `aligned_trimmed`, replace Aedes, Drosophila and Lucilia with the full sequence when available, and manually remove Nothomicrodon_185774 and Pseudacteon_378799. Results are saved in `aligned_trimmed_cleaned`.
5 - use phyutility to concatenate fasta sequences to `aligned_trimmed_cleaned/concatenated_alignment.nex`
6 - manually create an iqtree-style partition file based on phyutility result. for protein-coding genes, partition by codon position. for "12S_16S", use Geneious annotation feature to find boundaries of mitochondrial genes and create codon-based partitions for protein coding parts and a separate partition for non-protein-coding parts.

